app-id: org.skytemple.SkyTemple
runtime: org.gnome.Platform
runtime-version: '42'
sdk: org.gnome.Sdk
command: skytemple
finish-args:
  - "--share=network"
  - "--socket=fallback-x11"
  - "--socket=wayland"
  - "--filesystem=host"
  - "--talk-name=org.gtk.vfs.*"
  - "--filesystem=xdg-run/gvfsd"
modules:
  - name: armips
    buildsystem: simple
    build-commands:
      - mkdir -p build
      - patch Core/ExpressionFunctions.cpp < armips.patch
      - cd build && cmake -DCMAKE_BUILD_TYPE=Release ..
      - cd build && make armips-bin
      - install -Dm755 build/armips /app/bin/armips
    sources:
      - type: archive
        url: https://github.com/Kingcom/armips/archive/v0.11.0.tar.gz
        sha256: c94e29dfda3bdf853590d825562b9c73a3d8e8e995555e021c6b2a6451572681
      - type: file
        path: armips.patch
  - name: skytemple-assets
    buildsystem: simple
    build-commands:
      - mkdir -p /app/share/icons/hicolor/16x16/apps
      - install -Dm644 16x16/apps/skytemple.png /app/share/icons/hicolor/16x16/apps/org.skytemple.SkyTemple.png
      - mkdir -p /app/share/icons/hicolor/32x32/apps
      - install -Dm644 32x32/apps/skytemple.png /app/share/icons/hicolor/32x32/apps/org.skytemple.SkyTemple.png
      - mkdir -p /app/share/icons/hicolor/64x64/apps
      - install -Dm644 64x64/apps/skytemple.png /app/share/icons/hicolor/64x64/apps/org.skytemple.SkyTemple.png
      - mkdir -p /app/share/icons/hicolor/128x128/apps
      - install -Dm644 128x128/apps/skytemple.png /app/share/icons/hicolor/128x128/apps/org.skytemple.SkyTemple.png
      - mkdir -p /app/share/icons/hicolor/256x256/apps
      - install -Dm644 256x256/apps/skytemple.png /app/share/icons/hicolor/256x256/apps/org.skytemple.SkyTemple.png
      - mkdir -p /app/share/icons/hicolor/512x512/apps
      - install -Dm644 512x512/apps/skytemple.png /app/share/icons/hicolor/512x512/apps/org.skytemple.SkyTemple.png
      - install -Dm644 org.skytemple.SkyTemple.desktop /app/share/applications/org.skytemple.SkyTemple.desktop
      - install -Dm644 org.skytemple.SkyTemple.appdata.xml /app/share/metainfo/org.skytemple.SkyTemple.appdata.xml
    sources:
      - type: dir
        path: ../../skytemple/data/icons/hicolor
      - type: file
        path: org.skytemple.SkyTemple.desktop
      - type: file
        path: org.skytemple.SkyTemple.appdata.xml
  - name: skytemple
    buildsystem: simple
    build-options:
      build-args:
        - "--share=network"
    build-commands:
      # yes, this file also gernally applies to Linux Flatpak. We just don't care about specific versions of any of the
      # Sdk's bundled packages.
      - pip3 install --prefix=/app -r <(python fixup_requirements.py requirements-mac-windows.txt)
      - pip3 install --prefix=/app  .
    sources:
      - type: file
        path: fixup_requirements.py
      - type: dir
        path: ../..
        skip: ['installer', '.git', '.github']
